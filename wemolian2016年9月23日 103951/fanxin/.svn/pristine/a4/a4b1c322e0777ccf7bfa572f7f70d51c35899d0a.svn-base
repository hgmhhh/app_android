package com.wemolian.app.wml.friends;

import android.annotation.SuppressLint;
import android.content.Intent;
import android.graphics.Bitmap;
import android.os.Bundle;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.TextView;
import android.widget.Toast;

import com.wemolian.app.R;
import com.wemolian.app.WeMoLianApplication;
import com.wemolian.app.activity.BaseActivity;
import com.wemolian.app.domain.Contacts;
import com.wemolian.app.domain.Friends;
import com.wemolian.app.entity.Constant;
import com.wemolian.app.entity.LocalDBKey;
import com.wemolian.app.wml.AddFriendsFinalActivity;
import com.wemolian.app.wml.ChatActivity;
import com.wemolian.app.wml.UserInfoActivity;
import com.wemolian.app.wml.others.LoadUserAvatar;
import com.wemolian.app.wml.others.LocalUserInfo;
import com.wemolian.app.wml.others.LoadUserAvatar.ImageDownloadedCallBack;


/**
 * 从世界的朋友、附近的人中，添加好友
 * @author Administrator
 *
 */
public class AddFriendsFromAllUserActivity extends BaseActivity {

	
	private LoadUserAvatar avatarLoader;
	Button btn_sendmsg;
	ImageView iv_headImg;
	ImageView iv_sex;
	TextView tv_name;
	Friends friend;
	boolean is_friend = false;
	@SuppressLint("SdCardPath")
	@Override
	protected void onCreate(Bundle arg0) {
		super.onCreate(arg0);
		setContentView(R.layout.activity_userinfo);
		setStatus(findViewById(R.id.title));
		avatarLoader = new LoadUserAvatar(this, "/sdcard/wemolian/");
//	    Friends friend = (Friends)getIntent().getParcelableExtra("userInfo");
		friend = (Friends) getIntent().getExtras().get("userInfo");
		if(friend == null){
			Toast.makeText(this, "获取用户信息出错", Toast.LENGTH_SHORT).show();
			return;
		}
		btn_sendmsg = (Button) this.findViewById(R.id.btn_sendmsg);
		iv_headImg = (ImageView) this.findViewById(R.id.iv_avatar);
		iv_sex = (ImageView) this.findViewById(R.id.iv_sex);
		tv_name = (TextView) this.findViewById(R.id.tv_name);
		
		btn_sendmsg.setText("添加好友");
		tv_name.setText(friend.getUserCName());
		if (("1").equals(friend.getUserSex()) || "男".equals(friend.getUserSex())) {
            iv_sex.setImageResource(R.drawable.ic_sex_male);
        } else if ("2".equals(friend.getUserSex()) || "女".equals(friend.getUserSex())) {
            iv_sex.setImageResource(R.drawable.ic_sex_female);
        } else {
            iv_sex.setVisibility(View.GONE);
        }
		 if (WeMoLianApplication.getInstance().getContactList()
                 .containsKey(friend.getHxuserId())) {
             is_friend = true;
             btn_sendmsg.setText("发消息");
         }
		showUserAvatar(iv_headImg, friend.getHeadImg());
		
		btn_sendmsg.setOnClickListener(new OnClickListener() {

            @Override
            public void onClick(View v) {
                if(friend.getHxuserId().equals(LocalUserInfo.getInstance(getApplicationContext()).getUserInfo("hxid"))){
                    Toast.makeText(AddFriendsFromAllUserActivity.this, "不能和自己聊天。。", Toast.LENGTH_SHORT).show();
                    return ;
                }
                if (is_friend) {
                	Contacts con = new Contacts();
                	con.setExternalUse(friend.getExternalUse());
                	con = WeMoLianApplication.getInstance().getContact(con);
                	
                    Intent intent = new Intent();
                    intent.putExtra(LocalDBKey.CONTACTS_COLUMN_NAME_HXID, con.getHxid());
                    intent.putExtra(LocalDBKey.CONTACTS_COLUMN_NAME_IMGNAME, con.getImgName());
                    intent.putExtra(LocalDBKey.CONTACTS_COLUMN_NAME_USERCNAME, con.getNick() == null ? con.getUserCName() : con.getNick() );
                    intent.putExtra(LocalDBKey.CONTACTS_COLUMN_NAME_TYPE, "friend");
                    
                    intent.setClass(AddFriendsFromAllUserActivity.this, ChatActivity.class);
                    startActivity(intent);
                } else {

                    Intent intent = new Intent();
                    intent.putExtra(LocalDBKey.CONTACTS_COLUMN_NAME_HXID, friend.getHxuserId());
                     intent.putExtra(LocalDBKey.CONTACTS_COLUMN_NAME_IMGNAME, friend.getHeadImg());
                     intent.putExtra(LocalDBKey.CONTACTS_COLUMN_NAME_USERCNAME, friend.getUserCName());

                    intent.setClass(AddFriendsFromAllUserActivity.this,
                            AddFriendsFinalActivity.class);
                    startActivity(intent);

                }
            }

        });
	}
	
	
	
	
	
	
	
	
	
	private void showUserAvatar(ImageView iamgeView, String avatar) {
        final String url_avatar = Constant.URL_Avatar + avatar;
        iamgeView.setTag(url_avatar);
        if (url_avatar != null && !url_avatar.equals("")) {
            Bitmap bitmap = avatarLoader.loadImage(iamgeView, url_avatar,
                    new ImageDownloadedCallBack() {

                        public void onImageDownloaded(ImageView imageView,
                                Bitmap bitmap) {
                            if (imageView.getTag() == url_avatar) {
                                imageView.setImageBitmap(bitmap);

                            }
                        }

                    });
            if (bitmap != null)
                iamgeView.setImageBitmap(bitmap);

        }
    }
	
}
